*********

Welcome to Project 64!

  The goal of Project 64 is to preserve Commodore 64 related documents
in electronic text format that might otherwise cease to exist with the
rapid advancement of computer technology and declining interest in 8-
bit computers on the part of the general population.

  Extensive efforts were made to preserve the contents of the original
document.  However, certain portions, such as diagrams, program
listings, and indexes may have been either altered or sacrificed due
to the limitations of plain vanilla text.  Diagrams may have been
eliminated where ASCII-art was not feasible.  Program listings may be
missing display codes where substitutions were not possible.  Tables
of contents and indexes may have been changed from page number
references to section number references. Please accept our apologies
for these limitations, alterations, and possible omissions.

  The author(s) of the original document and members of Project 64 make
no representations about the accuracy or suitability of this material
for any purpose.  This etext is provided "as-is".  Please refer to the
warantee of the original document, if any, that may included in this
etext.  No other warantees, express or implied, are made to you as to
the etext or any medium it may be on.  Neither the author(s) nor the
members of Project 64 will assume liability for damages either from
the direct or indirect use of this etext or from the distribution of
or modification to this etext.  Therefore if you read this document or
use the information herein you do so at your own risk.

*********

  The Project 64 etext of Inside Commodore DOS by Richard Immers, Ph.D.
and Gerald G. Neufeld, Ph.D. second edition. Converted to etext by
Silver Dream !

INCDOS01.TXT (WIP), April 2014

*********




-----------------------------------------------------Header-----------------------------------------------------
﻿




                              INSIDE
                             COMMODORE
                                DOS























-----------------------------------------------------Page 1-----------------------------------------------------
﻿
-----------------------------------------------------Page 2-----------------------------------------------------
﻿



                                INSIDE
                              COMMODORE
                                 DOS

                                  by

                        Richard Immers, Ph.D.
                        Adrian Public Schools
                          Adrian, Michigan

                                and

                      Gerald G. Neufeld, Ph.D.
                        Brandon University
                         Brandon, Manitoba
                              Canada


                    Technical Illustrations by
                        Diane M. Corralejo

                           DATAMOST, Inc.
            19821 Nordhoff Street, Northridge, CA 91324
                          (818) 709-1202
-----------------------------------------------------Page 3-----------------------------------------------------
﻿



                    First Printing, July 1984
                  Second Printing, February 1985







                 RESTON PUBLISHING COMPANY, INC.
                    A Prentice-Hall Company
                       Reston, Virginia

                       ISBN 0-8359-3091-2

                Copyright © 1984 by DATAMOST, Inc.
                       All Rights Reserved

This manual is published and copyrighted by DATAMOST, Inc. All rights are
reserved by DATAMOST, Inc. Copying, duplicating, selling or otherwise
distributing this product is hereby expressly forbidden except by prior written
consent of DATAMOST, Inc.

The words COMMODORE, CBM, COMMODORE 64, VIC-20, VIC-1541 and the Commodore logo
are registered trademarks of Commodore Business Machines, Inc.

Commodore Business Machines was not in any way involved in the writing or other
preparation of this manual, nor were the facts presented here reviewed for
accuracy by them.

The information presented in this manual is the result of intensive study of
the disassembly of the 1541 DOS. Every effort has been made to provide
error-free information. However, neither the authors nor DATAMOST, Inc. can
accept responsibility for any loss or damage, tangible or intangible, resulting
from use or improper or unintended use of this information.

                                                       Printed in U.S.A.
-----------------------------------------------------Page 4-----------------------------------------------------
﻿


                        ACKNOWLEDGEMENTS

A manual like this one would not be possible without a great deal of technical
assistance. Mike Todd's Disk File column in the ICPUG Newsletter proved to be
an invaluable source of insight into the inner workings of Commodore's DOS.
Raeto West's book, Programming the PET/CBM, was a constant companion. Jim
Butterfield's numerous articles also provided valuable bits and pieces of
information. Brad Templeton's POWER™ system and PAL™ assembler made the
development of the programs in this manual a real joy. These packages are
commercially available from Professional Software Inc. In addition, both the
PAL disassembler and MICROMON were used as tools for disassembling the 1541 DOS.

We would also like to acknowledge the patience and forebearance of our families
and friends. Without their support, producing this manual would have been
considerably more difficult. Mike Louder of DATAMOST, Inc. also provided
tremendous support for its production.

Finally, we would like to extend a special note of thanks to Dr. Tom MacNeil
and Nancy Neufeld for their diligent work in proofreading this manual.

This manual was written on a Commodore computer system using the WordPro 4 Plus
word processing system. The WordPro Plus™ Series is commercially available from
Professional Software Inc. This sophisticated word processing system made
editing and last minute revisions much easier.
-----------------------------------------------------Page 5-----------------------------------------------------
﻿
-----------------------------------------------------Page 6-----------------------------------------------------
﻿



                        TABLE OF CONTENTS

Chapter 1 - INTRODUCTION
            A Brief Word About the Programs
            How to Type in the Programs

Chapter 2 - USING THE 1541'S DOS
            The Purpose of DOS
            Communicating with the 1541
            The Command Channel
            Using the Command Channel
            Diskette Housekeeping

Chapter 3 - DISKETTE FORMATTING
            Layout of Tracks and Sectors
            Layout of a Sector
            The Header Block
            The Data Block

Chapter 4 - DISKETTE ORGANIZATION
            Information Management
            The Directory You See
            The Block Availability Map
            The Directory Entries
            Program File Storage
            Sequential File Storage
            Relative File Storage
            User File Storage
            Deleted File Storage
            Locked Files

Chapter 5 - DIRECT-ACCESS PROGRAMMING
            Introduction to Direct-Access Programming
            Beginning Direct-Access Programming
            Block-Read Command
            Buffer-Pointer Command
            Block-Write Command
            Memory-Read Command
            Memory-Write Command
            Block-Allocate Command
            Block-Free Command
            Memory-Execute Command
            Block Execute Command
            Direct-Access Entomology

                                7
-----------------------------------------------------Page 7-----------------------------------------------------
﻿

Chapter 6 - INTERMEDIATE DIRECT-ACCESS PROGRAMMING

Chapter 7 - DOS PROTECTION
            Commodore's Data Encoding Scheme
            Checksums
            Description of DOS Error Messages
            Analyzing a Protected Diskette
            Duplicating a Protection Scheme
            How to Create 21 Errors on a Full Track
            How to Create a 21 Error on a Single Sector
            How to Create a 23 Error on a Single Sector
            How to Duplicate a 23 Error on a Single Sector
            How to Create 23 Errors on a Full Track
            How to Create 20 Errors on a Full Track
            How to Create 27 Errors on a Full Track
            How to Create a 22 Error on a Single Sector
            How to Duplicate a 22 Error on a Single Sector
            How to Format a Diskette with Multiple IDs
            How to Backup a DOS Protected Diskette
            How to Copy a File

Chapter 8 - GETTING OUT OF TROUBLE
            Unscratching a File
            Recovering a Soft Sector
            Recovering a Hard Sector
            Recovering a Relative File
            Recovering an Entire Diskette
            Recovering a Physically Damaged Diskette
            Recovering an Unclosed File
            Recovering from a Short New
            Recovering from a Full New

Chapter 9 - OVERVIEW OF THE 1541 DOS
            Introduction to 1541 DOS
            The Hard Working 6502
            Major IP Routines
            Using the IP Routines
            Major FDC Routines
            Using the FDC Routines
            The Recording Process
            Block Diagram of the 1541
            Writing Data to a Diskette
            Reading Data From a Diskette
            Summary Bugs in DOS 2.6
            Write Incompatibility with 4040
            Late News
-----------------------------------------------------Page 8-----------------------------------------------------
﻿
Appendix A - 1541 RAM VARIABLE DEFINITIONS

Appendix B - ANALYSIS OF THE 1541's ROM

Appendix C - PROGRAM LISTINGS

Appendix D - MATHEMATICAL CONVERSION ROUTINES

Index
-----------------------------------------------------Page 9-----------------------------------------------------
﻿
Ignorance is a precious thing.
Once lost, it can never be regained.
-----------------------------------------------------Page 10-----------------------------------------------------
﻿
CHAPTER 1

INTRODUCTION

This manual is intended to supplement the documentation provided in the 1541
User's Manual. Although this manual is primarily designed to meet the needs of
the intermediate to advanced programmer, it will also be of interest to the
novice Commodore user who wants to know more about how his 1541 disk drive
works. This manual is not intended to replace the documentation provided by
Commodore Business Machines, Inc. and the reader is assumed to be relatively
familiar with the contents of the 1541 User's Manual. For the sake of
continuity and clarity, some of the information covered in the 1541 User's
Manual is also presented here. However, the majority of the information
presented in this manual is original and is the result of intensive disassembly
and annotation of the 1541's DOS by the authors. Some information is based on
articles and notes published in a variety of publications as well as
discussions with other knowledgeable disk experts.

This manual was not prepared with the assistance of Commodore Business
Machines, Inc. Although we cannot guarantee the accuracy of all the information
presented in this manual, the material has been thoroughly researched and
tested.

There were several reasons for writing Inside Commodore DOS:

1. To correct errors and omissions in the 1541 User's Manual.
2. To help you make more effective use of your disk drive.
3. To provide complete information on diskette formatting.
4. To provide complete information on the storage of files.
5. To allow you to read and write data in non-standard ways.
6. To help you make a backup copy of your "protected" diskettes.
7. To help you recover damaged diskettes.
8. To help you understand the operation of your disk drive.

Although this manual focuses primarily on the 1541 disk drive, much of the
information also applies to other Commodore disk drives.

1.1 A Brief Word About the Programs

This book contains listings for 46 ready-to-use programs written in BASIC.
These programs are copyrighted. They may NOT be used commercially, in whole
or in part, period. Since many of the programs are long, typing them all in
would be a time consuming, tedious task. Feel free to share your typing efforts
with a friend who has also purchased a copy of this book. In return, we simply
ask that you do not share a program with someone who does not own a
legitimate copy of this book.

                                    11
-----------------------------------------------------Page 11-----------------------------------------------------
﻿
The programs in this book are disk utilities. They do not use flashy graphics
or sound. Rather, they are extremely powerful tools. Remember, any tool can be
dangerous if it is used improperly. Be sure that you know what you are doing
before you use a given program. Always experiment with a program on a test
diskette before you actually use it on one that contains valuable programs or
data. Practice makes perfect.

Each program was individually tested on a variety of 1541 disk drives having a
wide range of serial numbers. Moreover, each program always worked perfectly.
Unfortunately, it is impossible to guarantee that a particular program will
work with your model. If a given program does not seem to work properly, check
your typing carefully. Any errors, especially in the DATA statements which
contain a machine language program, will produce problems.

As a courtesy to the more advanced programmer, we have also included the source
listings for each machine language routine A source listing immediately follows
a related BASIC program listing and has a file name ending in ".PAL". It is for
use with the PAL assembler. Note: If you are using a different assembler, you
may have to make some minor changes.

The programs in this book were designed to be not only useful and beneficial,
but instructive as well. Many of them illustrate the "state of the art" in
the use of Commodore's direct-access disk commands. Enjoy!

1.2 How to Type in the Programs

Program listings in books and magazines often suffer from two problems:
typographical errors that occur when the program is retyped into a word
processor and the readability of Commodore's control characters (e.g., the
reverse field heart that means Clear Screen). To overcome these problems, the
program listings for this book were created using a special "lister" program.
This lister program took a working BASIC program and converted it into a
WordPro™ file. At the same time, control characters were spelled out in words
and surrounded by curly brackets. For example, a reverse field heart was
converted to {CLR}. The table below summarizes the listing conventions, the
corresponding control characters, and the proper key/keys to press on your
C64 or VIC-20.

When You See		What It Represents	What You Type
----------------	--------------------	--------------
{CLR}			Clear Screen		Hold down SHIFT and press
						CLR/HOME
{HOME}			Home Cursor		Press CLR/HOME
{DOWN}			Cursor Down		Press CRSR/DOWN
{UP}			Cursor Up		Hold down SHIFT and press
						CRSR/UP
{RIGHT}			Cursor Right		Press CRSR/RIGHT
{LEFT}			Cursor Left		Hold down SHIFT and press
						CRSR/LEFT
{RVS}			Reverse Field ON	Hold down CTRL and press 9
{ROFF}			Reverse Field OFF	Hold down CTRL and press 0


                                   12
-----------------------------------------------------Page 12-----------------------------------------------------
﻿
